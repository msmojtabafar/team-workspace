{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="text-3xl font-bold mb-2">{{ project.title }}</h1>
                <p class="text-gray-600">{{ project.description }}</p>
            </div>
            <div class="flex space-x-3 space-x-reverse">
                <a href="{% url 'upload_project_attachment' project.id %}" 
                   class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center">
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    آپلود فایل
                </a>
                <span class="px-3 py-1 rounded-full text-sm 
                    {% if project.status == 'active' %}bg-green-100 text-green-800
                    {% elif project.status == 'completed' %}bg-gray-100 text-gray-800
                    {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                    {{ project.get_status_display }}
                </span>
            </div>
        </div>
        <div class="flex items-center text-gray-500">
            <span>ایجاد شده توسط: {{ project.created_by.username }}</span>
            <span class="mx-2">•</span>
            <span>آخرین بروزرسانی: {{ project.updated_at|date:"Y/m/d" }}</span>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- بخش تسک‌ها -->
        <div class="lg:col-span-2 space-y-6">
            <!-- فرم ایجاد تسک -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-4">ایجاد تسک جدید</h2>
                <form method="post" class="space-y-4">
                    {% csrf_token %}
                    <div>
                        <input type="text" name="title" placeholder="عنوان تسک" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <textarea name="description" placeholder="توضیحات تسک" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md" rows="3"></textarea>
                    </div>
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        ایجاد تسک
                    </button>
                </form>
            </div>

            <!-- لیست تسک‌ها -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-4">تسک‌ها</h2>
                {% for task in tasks %}
                <div class="border-b border-gray-200 py-4 last:border-b-0">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-semibold">{{ task.title }}</h3>
                            <p class="text-gray-600 text-sm mt-1">{{ task.description }}</p>
                            
                            <!-- فایل‌های تسک -->
                            {% if task.attachments.exists %}
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 mb-1">فایل‌های ضمیمه:</p>
                                <div class="flex flex-wrap gap-2">
                                    {% for attachment in task.attachments.all %}
                                    <a href="{% url 'download_attachment' attachment.id %}" 
                                       class="flex items-center space-x-2 space-x-reverse bg-gray-100 px-3 py-1 rounded-lg text-sm hover:bg-gray-200">
                                        <span>{{ attachment.get_file_icon }}</span>
                                        <span>{{ attachment.file_name }}</span>
                                        <span class="text-gray-500 text-xs">({{ attachment.get_file_size_display }})</span>
                                    </a>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="flex flex-col items-end space-y-2">
                            <span class="px-2 py-1 rounded text-xs 
                                {% if task.status == 'todo' %}bg-gray-100 text-gray-800
                                {% elif task.status == 'in_progress' %}bg-blue-100 text-blue-800
                                {% elif task.status == 'review' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-green-100 text-green-800{% endif %}">
                                {{ task.get_status_display }}
                            </span>
                            <span class="text-xs text-gray-500">{{ task.created_by.username }}</span>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-center py-4">هنوز تسکی وجود ندارد.</p>
                {% endfor %}
            </div>
        </div>

        <!-- سایدبار -->
        <div class="space-y-6">
            <!-- فایل‌های پروژه -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">فایل‌های پروژه</h2>
                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                        {{ project.attachments.count }} فایل
                    </span>
                </div>
                
                {% if project.attachments.exists %}
                <div class="space-y-3">
                    {% for attachment in project.attachments.all %}
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                        <div class="flex items-center space-x-3 space-x-reverse">
                            <span class="text-lg">{{ attachment.get_file_icon }}</span>
                            <div>
                                <a href="{% url 'download_attachment' attachment.id %}" 
                                   class="font-medium text-blue-600 hover:text-blue-800">
                                    {{ attachment.file_name }}
                                </a>
                                <p class="text-xs text-gray-500">
                                    {{ attachment.get_file_size_display }} • {{ attachment.uploaded_by.username }}
                                </p>
                            </div>
                        </div>
                        {% if attachment.uploaded_by == user or user.is_staff %}
                        <form method="post" action="{% url 'delete_attachment' attachment.id %}" class="inline">
                            {% csrf_token %}
                            <button type="submit" 
                                    onclick="return confirm('آیا از حذف این فایل مطمئن هستید؟')"
                                    class="text-red-600 hover:text-red-800 text-sm">
                                حذف
                            </button>
                        </form>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-4">هنوز فایلی آپلود نشده است.</p>
                {% endif %}
                
                <div class="mt-4">
                    <a href="{% url 'upload_project_attachment' project.id %}" 
                       class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                        <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        افزودن فایل جدید
                    </a>
                </div>
            </div>

            <!-- بخش چت -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">چت پروژه</h2>
                <div id="chat-messages" class="h-64 overflow-y-auto mb-4 border border-gray-200 rounded p-4">
                    <!-- پیام‌های چت اینجا نمایش داده می‌شوند -->
                </div>
                <div class="flex">
                    <input type="text" id="chat-message-input" 
                           placeholder="پیام خود را بنویسید..." 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-r-md">
                    <button id="chat-message-submit" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-l-md hover:bg-blue-700">
                        ارسال
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const projectId = {{ project.id }};
    
    // WebSocket برای چت
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + projectId + '/'
    );
    
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const chatMessages = document.querySelector('#chat-messages');
        
        const messageElement = document.createElement('div');
        messageElement.innerHTML = `
            <strong>${data.username}:</strong> ${data.message}
            <span class="text-xs text-gray-500">${new Date(data.timestamp).toLocaleTimeString()}</span>
        `;
        
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };
    
    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {
            document.querySelector('#chat-message-submit').click();
        }
    };
    
    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        
        if (message) {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        }
    };
</script>
{% endblock %}
